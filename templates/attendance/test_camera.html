{% extends 'base.html' %}

{% block title %}Test Camera - Attendance Management System{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-8 mx-auto">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">Camera Test</h6>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <h4>Camera Functionality Test</h4>
                        <p>This page tests the camera functionality for the attendance system.</p>
                    </div>

                    <div class="text-center mb-3">
                        <div id="camera-container" class="mx-auto mb-3" style="width: 400px; height: 300px; border: 1px solid #ddd; background-color: #f8f9fc; display: flex; align-items: center; justify-content: center;">
                            <span class="text-muted">Camera feed will appear here</span>
                        </div>
                        <button type="button" id="start-camera" class="btn btn-outline-primary">
                            <i class="fas fa-video me-1"></i>Start Camera
                        </button>
                        <input type="file" id="face_image" name="face_image" accept="image/*" style="display: none;">
                    </div>

                    <div class="mt-4">
                        <h5>Test Results:</h5>
                        <div id="test-results">
                            <p class="text-muted">Click "Start Camera" to test camera functionality.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const startCameraBtn = document.getElementById('start-camera');
        const testResults = document.getElementById('test-results');
        
        // Check browser compatibility
        function checkBrowserSupport() {
            const checks = {
                'MediaDevices API': !!navigator.mediaDevices,
                'getUserMedia': !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia),
                'HTTPS/SSL': window.location.protocol === 'https:' || window.location.hostname === 'localhost',
                'Modern Browser': !!window.Promise && !!window.fetch
            };
            
            let supportHTML = '<h6>Browser Support Check:</h6><ul>';
            for (const [feature, supported] of Object.entries(checks)) {
                supportHTML += `<li>${feature}: ${supported ? '✅' : '❌'}</li>`;
            }
            supportHTML += '</ul>';
            
            return supportHTML;
        }
        
        // Show initial browser support
        testResults.innerHTML = checkBrowserSupport();
        
        if (startCameraBtn) {
            startCameraBtn.addEventListener('click', async function() {
                testResults.innerHTML = '<p class="text-info">Testing camera access...</p>';
                
                try {
                    console.log('Testing camera access...');
                    
                    // Test basic camera access
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: {
                            width: { ideal: 640 },
                            height: { ideal: 480 },
                            facingMode: 'user'
                        }
                    });
                    
                    console.log('Camera stream obtained:', stream);
                    
                    testResults.innerHTML = `
                        <div class="alert alert-success">
                            <h6>✅ Camera Test Successful!</h6>
                            <ul class="mb-0">
                                <li>Camera access granted</li>
                                <li>Video stream started</li>
                                <li>Camera functionality is working</li>
                                <li>Tracks: ${stream.getTracks().length}</li>
                            </ul>
                        </div>
                    `;
                    
                    // Stop the stream after testing
                    stream.getTracks().forEach(track => track.stop());
                    
                } catch (error) {
                    console.error('Camera test failed:', error);
                    testResults.innerHTML = `
                        <div class="alert alert-danger">
                            <h6>❌ Camera Test Failed</h6>
                            <p class="mb-0"><strong>Error:</strong> ${error.message}</p>
                            <p class="mb-0"><strong>Error Type:</strong> ${error.name}</p>
                            <small class="text-muted">
                                Troubleshooting tips:
                                <ul class="mb-0 mt-2">
                                    <li>Make sure you have granted camera permissions to this website</li>
                                    <li>Check if your camera is connected and working</li>
                                    <li>Try refreshing the page and allowing permissions again</li>
                                    <li>Use a modern browser (Chrome, Firefox, Safari, Edge)</li>
                                </ul>
                            </small>
                        </div>
                    `;
                }
            });
        }
    });
</script>
{% endblock %}
{% endblock %} 